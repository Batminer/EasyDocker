version: "3.5"
#https://github.com/harveyconnor/traefikv2-docker-gitlab
networks:
  vpn:
    external: true
services:
  gitlab:
    container_name: gitlab
    image: gitlab/gitlab-ce:latest
    restart: always
    ports:
      - "SECONDPORT:22"
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url DOMAINSUBNAMEHERE
        nginx['listen_https'] = false
        nginx['listen_port'] = PORTHERE
        gitlab_rails['smtp_enable'] = true
        gitlab_rails['smtp_address'] = ${GITLAB_SMTP_ADDR}
        gitlab_rails['smtp_port'] = ${GITLAB_SMTP_PORT}
        gitlab_rails['smtp_user_name'] = ${GITLAB_SMTP_USER}
        gitlab_rails['smtp_password'] = ${GITLAB_SMTP_PASSWORD}
        gitlab_rails['smtp_domain'] = ${GITLAB_SMTP_DOMAIN}
        gitlab_rails['smtp_authentication'] = "login"
        gitlab_rails['smtp_enable_starttls_auto'] = true
        gitlab_rails['smtp_tls'] = false
        gitlab_rails['smtp_openssl_verify_mode'] = 'peer'
        gitlab_rails['gitlab_shell_ssh_port'] = SECONDPORT
    labels:
      - traefik.http.routers.gitlab.rule=Host(DOMAINSUBNAMEHERE)
      - traefik.http.routers.gitlab.entrypoints=websecure
      - traefik.http.routers.gitlab.tls.certresolver=production
      - traefik.http.services.gitlab.loadbalancer.server.port=PORTHERE
      - traefik.docker.network=vpn
      - traefik.tcp.routers.gitlab-ssh.rule=HostSNI(DOMAINSUBNAMEHERE)
      - traefik.tcp.routers.gitlab-ssh.entrypoints=ssh
      - traefik.tcp.routers.gitlab-ssh.service=gitlab-ssh-svc
      - traefik.tcp.services.gitlab-ssh-svc.loadbalancer.server.port=SECONDPORT
    volumes:
      - ./config:/etc/gitlab
      - ./logs:/var/log/gitlab
      - ./data:/var/opt/gitlab
    networks:
      vpn:
        ipv4_address: IPADDRESSHERE

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    volumes:
      - ./runner/config/:/etc/gitlab-runner:Z
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      vpn:
        ipv4_address: 10.8.1.115
    labels:
      - traefik.enable=false